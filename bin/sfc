#!/bin/bash

set -e

if ! command -v jq &> /dev/null || ! command -v git &> /dev/null ; then
  echo "The jq and git programs are required to use this script"
  exit 1
fi

get_story_branch ()
{
  resp=$(
  curl -s -w '\n%{http_code}' -X GET \
    -H "Content-Type: application/json" \
    -H "Shortcut-Token: ${SHORTCUT_API_TOKEN}" \
    -L "https://api.app.shortcut.com/api/v3/stories/${1}"
  )

  local http_status="${resp##*$'\n'}"
  local json="${resp%%$'\n'*}"

  case "${http_status}" in
    200)
      local slugified_ticket_name=$(
        echo "${json}" \
          | jq .name \
          | iconv -t ascii//TRANSLIT \
          | sed -r s/[^a-zA-Z0-9]+/-/g \
          | sed -r s/^-+\|-+$//g | tr A-Z a-z
      )

      echo "sc-${1}/${slugified_ticket_name}"
      ;;

    400)
      echo "No story with id \"${1}\""
      ;;

    401)
      echo "Unathorized"
      ;;

    404)
      echo "Not found"
      ;;

    *)
      echo "Got HTTP ${http_status}. Payload:"
      echo "${json}"
      exit 1
      ;;
  esac
}


branch=$(get_story_branch $1)

git checkout -b "sc-${1}/${branch}"
